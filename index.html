<!DOCTYPE html>
<html lang="fr">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Assistant de RÃ©daction FLE B1</title>
Â 
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
Â 
Â  <style>
Â Â Â  .step-active { border-bottom: 4px solid #3b82f6; color: #1e40af; }
Â Â Â  .word-count-success { color: #059669; font-weight: bold; }
Â Â Â  .word-count-warn { color: #d97706; }
Â Â Â  .word-count-error { color: #dc2626; }
Â  </style>
</head>
Â 
<body class="bg-slate-50 min-h-screen font-sans">
Â  <div class="max-w-5xl mx-auto p-4 md:p-8">
Â Â Â  <!-- Header -->
Â Â Â  <header class="bg-white rounded-xl shadow-sm p-6 mb-6 border-l-8 border-blue-600">
Â Â Â Â Â  <h1 class="text-3xl font-bold text-slate-800">âœï¸ Assistant de RÃ©daction <span class="text-blue-600">B1</span></h1>
Â Â Â Â Â  <p class="text-slate-600 mt-2">ThÃ¨me : <span class="italic">Forum de discussion - L'Ã©cologie au quotidien</span></p>
Â Â Â Â Â  <div class="mt-4 p-4 bg-blue-50 rounded-lg text-sm text-blue-800 border border-blue-100">
Â Â Â Â Â Â Â  <strong>Consigne d'examen :</strong> Vous participez Ã  un forum de discussion intitulÃ©
Â Â Â Â Â Â Â  "Consommer moins, vivre mieux ?". Vous donnez votre avis sur le zÃ©ro dÃ©chet.
Â Â Â Â Â Â Â  Est-ce possible selon vous ? Quels sont les avantages et les difficultÃ©s ? (160 mots minimum).
Â Â Â Â Â  </div>
Â Â Â  </header>
Â 
Â Â Â  <!-- Navigation Onglets -->
Â Â Â  <div class="flex space-x-4 mb-6 bg-white p-2 rounded-lg shadow-sm">
Â Â Â Â Â  <button onclick="switchTab('guidage')" id="tab-guidage"
Â Â Â Â Â Â Â  class="flex-1 py-2 text-center font-semibold step-active transition-all">
Â Â Â Â Â Â Â  <i class="fa-solid fa-map-signs mr-2"></i>Mode Guidage
Â Â Â Â Â  </button>
Â 
Â Â Â Â Â  <button onclick="switchTab('libre')" id="tab-libre"
Â Â Â Â Â Â Â  class="flex-1 py-2 text-center font-semibold text-slate-400 hover:text-slate-600 transition-all">
Â Â Â Â Â Â Â  <i class="fa-solid fa-pen-nib mr-2"></i>RÃ©daction Libre
Â Â Â Â Â  </button>
Â Â Â  </div>
Â 
Â Â Â  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
Â Â Â Â Â  <!-- Zone d'Ã©criture principale -->
Â Â Â Â Â  <div class="lg:col-span-2 space-y-4">
Â 
Â Â Â Â Â Â Â  <!-- Interface Guidage -->
Â Â Â Â Â Â Â  <div id="view-guidage" class="space-y-4">
Â Â Â Â Â Â Â Â Â  <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-bold text-slate-700 mb-2">1. Introduction (Le contexte)</label>
Â Â Â Â Â Â Â Â Â Â Â  <select onchange="insertAmorce('intro', this)"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="">SÃ©lectionner une amorce...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Je voudrais rÃ©agir au message de...">Je voudrais rÃ©agir au message de...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Concernant le dÃ©bat sur..., je pense que...">Concernant le dÃ©bat sur..., je pense que...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="C'est une question trÃ¨s actuelle car...">C'est une question trÃ¨s actuelle car...</option>
Â Â Â Â Â Â Â Â Â Â Â  </select>
Â Â Â Â Â Â Â Â Â Â Â  <textarea id="text-intro"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[80px]"
Â Â Â Â Â Â Â Â Â Â Â Â Â  placeholder="PrÃ©sentez le sujet..."></textarea>
Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â  <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-bold text-slate-700 mb-2">2. Corps du texte (Arguments)</label>
Â Â Â Â Â Â Â Â Â Â Â  <select onchange="insertAmorce('corps', this)"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="">SÃ©lectionner une amorce...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Tout d'abord, il faut dire que...">Tout d'abord, il faut dire que...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="D'un cÃ´tÃ©..., mais d'un autre cÃ´tÃ©...">D'un cÃ´tÃ©..., mais d'un autre cÃ´tÃ©...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Par exemple, dans ma ville...">Par exemple, dans ma ville...</option>
Â Â Â Â Â Â Â Â Â Â Â  </select>
Â Â Â Â Â Â Â Â Â Â Â  <textarea id="text-corps"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[150px]"
Â Â Â Â Â Â Â Â Â Â Â Â Â  placeholder="DÃ©veloppez vos idÃ©es..."></textarea>
Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â  <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-bold text-slate-700 mb-2">3. Conclusion (SynthÃ¨se)</label>
Â Â Â Â Â Â Â Â Â Â Â  <select onchange="insertAmorce('concl', this)"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="">SÃ©lectionner une amorce...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="En conclusion, je crois que...">En conclusion, je crois que...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Pour finir, il est essentiel de...">Pour finir, il est essentiel de...</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <option value="Et vous, qu'en pensez-vous ?">Et vous, qu'en pensez-vous ?</option>
Â Â Â Â Â Â Â Â Â Â Â  </select>
Â Â Â Â Â Â Â Â Â Â Â  <textarea id="text-concl"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[80px]"
Â Â Â Â Â Â Â Â Â Â Â Â Â  placeholder="Terminez votre message..."></textarea>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Interface Libre -->
Â Â Â Â Â Â Â  <div id="view-libre" class="hidden">
Â Â Â Â Â Â Â Â Â  <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col">
Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-bold text-slate-700 mb-2">Ã‰diteur final</label>
Â Â Â Â Â Â Â Â Â Â Â  <textarea id="main-editor"
Â Â Â Â Â Â Â Â Â Â Â Â Â  class="flex-grow w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[350px]"
Â Â Â Â Â Â Â Â Â Â Â Â Â  placeholder="Votre texte complet ici..."></textarea>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Actions Bas de Page -->
Â Â Â Â Â Â Â  <div class="flex flex-wrap gap-3 justify-between items-center bg-white p-4 rounded-xl shadow-sm">
Â Â Â Â Â Â Â Â Â  <div class="flex space-x-4 items-center">
Â Â Â Â Â Â Â Â Â Â Â  <button onclick="readText()" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Ã‰couter le texte">
Â Â Â Â Â Â Â Â Â Â Â Â Â  <i class="fa-solid fa-volume-high text-xl"></i>
Â Â Â Â Â Â Â Â Â Â Â  </button>
Â Â Â Â Â Â Â Â Â Â Â  <div id="word-count-display" class="text-sm font-medium text-slate-500">
Â Â Â Â Â Â Â Â Â Â Â Â Â  Mots : <span id="word-count">0</span> / 160
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â  <button onclick="analyzeText()" id="btn-analyze"
Â Â Â Â Â Â Â Â Â Â Â  class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center shadow-lg shadow-blue-200">
Â Â Â Â Â Â Â Â Â Â Â  <span id="analyze-spinner" class="hidden mr-2"><i class="fa-solid fa-circle-notch animate-spin"></i></span>
Â Â Â Â Â Â Â Â Â Â Â  <i class="fa-solid fa-bolt mr-2"></i>Analyser ma production
Â Â Â Â Â Â Â Â Â  </button>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  </div>
Â 
Â Â Â Â Â  <!-- Barre latÃ©rale -->
Â Â Â Â Â  <aside class="space-y-6">
Â Â Â Â Â Â Â  <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
Â Â Â Â Â Â Â Â Â  <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">
Â Â Â Â Â Â Â Â Â Â Â  <i class="fa-solid fa-link mr-2 text-blue-500"></i>Connecteurs
Â Â Â Â Â Â Â Â Â  </h3>
Â 
Â Â Â Â Â Â Â Â Â  <div class="space-y-4">
Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <p class="text-xs font-bold text-slate-400 uppercase mb-2">Addition</p>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="flex flex-wrap gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('De plus, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">De plus</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('Par ailleurs, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">Par ailleurs</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('Ã‰galement, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">Ã‰galement</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <p class="text-xs font-bold text-slate-400 uppercase mb-2">Cause / ConsÃ©q.</p>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="flex flex-wrap gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('Car ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">Car</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('C\\'est pourquoi ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">C'est pourquoi</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('GrÃ¢ce Ã  ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">GrÃ¢ce Ã </button>
Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <p class="text-xs font-bold text-slate-400 uppercase mb-2">Opposition</p>
Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="flex flex-wrap gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('Pourtant, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">Pourtant</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('Cependant, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">Cependant</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="insertTool('En revanche, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">En revanche</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Feedback Panel -->
Â Â Â Â Â Â Â  <div id="feedback-panel" class="hidden bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
Â Â Â Â Â Â Â Â Â  <h3 class="font-bold text-slate-800 mb-3 flex items-center">
Â Â Â Â Â Â Â Â Â Â Â  <i class="fa-solid fa-chart-line mr-2 text-blue-500"></i>RÃ©sultats
Â Â Â Â Â Â Â Â Â  </h3>
Â Â Â Â Â Â Â Â Â  <div id="feedback-content" class="text-sm space-y-4"></div>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  </aside>
Â Â Â  </div>
Â  </div>
Â 
Â  <!-- Error Toast -->
Â  <div id="toast" class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-xl hidden transition-opacity duration-300">
Â Â Â  Une erreur est survenue.
Â  </div>
Â 
Â  <!-- SCRIPT INTÃ‰GRÃ‰ (corrigÃ© + Gemini) -->
Â  <script>
Â Â Â  /* =========================
Â Â Â Â Â Â  CONFIGURATION GEMINI
Â Â Â Â Â Â  ========================= */
Â 
Â Â Â  // ğŸ”‘ Mets ta clÃ© sur UNE SEULE LIGNE, sans espaces ni retours
Â Â Â  const apiKey = "AIzaSyCspwwcENEEtNjC4k1AhpvwPwyabPRfYiA";
Â 
Â Â Â  // ModÃ¨le Gemini (adapter si besoin)
Â Â Â  const MODEL_ID = "gemini-2.5-flash-preview-09-2025";
Â 
Â Â Â  /* =========================
Â Â Â Â Â Â  Ã‰TAT DE Lâ€™APPLICATION
Â Â Â Â Â Â  ========================= */
Â 
Â Â Â  let currentTab = "guidage";
Â Â Â  let lastFocusedId = "text-intro";
Â 
Â Â Â  document.querySelectorAll("textarea").forEach(el => {
Â Â Â Â Â  el.addEventListener("focus", () => (lastFocusedId = el.id));
Â Â Â Â Â  el.addEventListener("input", updateWordCount);
Â Â Â  });
Â 
Â Â Â  /* =========================
Â Â Â Â Â Â  OUTILS UI
Â Â Â Â Â Â  ========================= */
Â 
Â Â Â  function showToast(msg) {
Â Â Â Â Â  const toast = document.getElementById("toast");
Â Â Â Â Â  toast.innerText = msg;
Â Â Â Â Â  toast.classList.remove("hidden");
Â Â Â Â Â  setTimeout(() => toast.classList.add("hidden"), 5000);
Â Â Â  }
Â 
Â Â Â  function getFullText() {
Â Â Â Â Â  if (currentTab === "guidage") {
Â Â Â Â Â Â Â  return [
Â Â Â Â Â Â Â Â Â  document.getElementById("text-intro").value || "",
Â Â Â Â Â Â Â Â Â  document.getElementById("text-corps").value || "",
Â Â Â Â Â Â Â Â Â  document.getElementById("text-concl").value || ""
Â Â Â Â Â Â Â  ].join("\n\n").trim();
Â Â Â Â Â  }
Â Â Â Â Â  return (document.getElementById("main-editor").value || "").trim();
Â Â Â  }
Â 
Â Â Â  function updateWordCount() {
Â Â Â Â Â  const text = getFullText();
Â Â Â Â Â  const words = text ? text.trim().split(/\s+/).filter(Boolean).length : 0;
Â 
Â Â Â Â Â  const display = document.getElementById("word-count");
Â Â Â Â Â  display.textContent = words;
Â Â Â Â Â  display.className = "";
Â 
Â Â Â Â Â  if (words >= 160) display.classList.add("word-count-success");
Â Â Â Â Â  else if (words > 120) display.classList.add("word-count-warn");
Â Â Â Â Â  else display.classList.add("word-count-error");
Â Â Â  }
Â 
Â Â Â  function switchTab(tab) {
Â Â Â Â Â  currentTab = tab;
Â 
Â Â Â Â Â  const guidage = document.getElementById("view-guidage");
Â Â Â Â Â  const libre = document.getElementById("view-libre");
Â Â Â Â Â  const tabG = document.getElementById("tab-guidage");
Â Â Â Â Â  const tabL = document.getElementById("tab-libre");
Â 
Â Â Â Â Â  if (tab === "libre") {
Â Â Â Â Â Â Â  document.getElementById("main-editor").value = getFullText();
Â Â Â Â Â Â Â  guidage.classList.add("hidden");
Â Â Â Â Â Â Â  libre.classList.remove("hidden");
Â 
Â Â Â Â Â Â Â  tabL.classList.add("step-active");
Â Â Â Â Â Â Â  tabG.classList.remove("step-active");
Â 
Â Â Â Â Â Â Â  tabL.classList.remove("text-slate-400");
Â Â Â Â Â Â Â  tabG.classList.add("text-slate-400");
Â 
Â Â Â Â Â Â Â  lastFocusedId = "main-editor";
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  guidage.classList.remove("hidden");
Â Â Â Â Â Â Â  libre.classList.add("hidden");
Â 
Â Â Â Â Â Â Â  tabG.classList.add("step-active");
Â Â Â Â Â Â Â  tabL.classList.remove("step-active");
Â 
Â Â Â Â Â Â Â  tabG.classList.remove("text-slate-400");
Â Â Â Â Â Â Â  tabL.classList.add("text-slate-400");
Â 
Â Â Â Â Â Â Â  lastFocusedId = "text-intro";
Â Â Â Â Â  }
Â 
Â Â Â Â Â  updateWordCount();
Â Â Â  }
Â 
Â Â Â  function insertTool(text) {
Â Â Â Â Â  const el = document.getElementById(lastFocusedId);
Â Â Â Â Â  if (!el) return;
Â 
Â Â Â Â Â  const start = el.selectionStart ?? el.value.length;
Â Â Â Â Â  const end = el.selectionEnd ?? el.value.length;
Â 
Â Â Â Â Â  el.value = el.value.substring(0, start) + text + el.value.substring(end);
Â Â Â Â Â  el.focus();
Â Â Â Â Â  el.selectionStart = el.selectionEnd = start + text.length;
Â 
Â Â Â Â Â  updateWordCount();
Â Â Â  }
Â 
Â Â Â  function insertAmorce(segment, select) {
Â Â Â Â Â  if (!select.value) return;
Â Â Â Â Â  const el = document.getElementById("text-" + segment);
Â Â Â Â Â  el.value = select.value + "\n" + (el.value || "");
Â Â Â Â Â  select.value = "";
Â Â Â Â Â  updateWordCount();
Â Â Â  }
Â 
Â Â Â  function readText() {
Â Â Â Â Â  const text = getFullText();
Â Â Â Â Â  if (!text) return;
Â 
Â Â Â Â Â  const msg = new SpeechSynthesisUtterance(text);
Â Â Â Â Â  msg.lang = "fr-FR";
Â Â Â Â Â  speechSynthesis.cancel();
Â Â Â Â Â  speechSynthesis.speak(msg);
Â Â Â  }
Â 
Â Â Â  /* =========================
Â Â Â Â Â Â  ANALYSE GEMINI
Â Â Â Â Â Â  ========================= */
Â 
Â Â Â  function extractJson(text) {
Â Â Â Â Â  const start = text.indexOf("{");
Â Â Â Â Â  const end = text.lastIndexOf("}");
Â Â Â Â Â  if (start === -1 || end === -1 || end <= start) {
Â Â Â Â Â Â Â  throw new Error("RÃ©ponse non-JSON");
Â Â Â Â Â  }
Â Â Â Â Â  return text.slice(start, end + 1);
Â Â Â  }
Â 
Â Â Â  async function analyzeText() {
Â Â Â Â Â  if (!apiKey || apiKey === "COLLE_TA_CLE_ICI") {
Â Â Â Â Â Â Â  showToast("Ajoute ta clÃ© API Gemini dans apiKey (une seule ligne, sans espace).");
Â Â Â Â Â Â Â  return;
Â Â Â Â Â  }
Â 
Â Â Â Â Â  const text = getFullText();
Â Â Â Â Â  if (text.trim().length < 20) {
Â Â Â Â Â Â Â  showToast("Texte trop court pour Ãªtre analysÃ©.");
Â Â Â Â Â Â Â  return;
Â Â Â Â Â  }
Â 
Â Â Â Â Â  const btn = document.getElementById("btn-analyze");
Â Â Â Â Â  const spinner = document.getElementById("analyze-spinner");
Â Â Â Â Â  const panel = document.getElementById("feedback-panel");
Â Â Â Â Â  const content = document.getElementById("feedback-content");
Â 
Â Â Â Â Â  btn.disabled = true;
Â Â Â Â Â  spinner.classList.remove("hidden");
Â 
Â Â Â Â Â  const systemPrompt = `
Tu es un examinateur expert en certifications DELF B1.
Analyse la production Ã©crite de l'apprenant.
RÃ©ponds STRICTEMENT en JSON (aucun texte autour) avec cette structure :
{
Â  "analyseTextualite": "string (rÃ©sumÃ© global de la cohÃ©rence)",
Â  "erreurs": [{"texte":"string","type":"Grammaire/Lexique/Orthographe","conseil":"string"}],
Â  "suggestions": ["string"],
Â  "noteEstimation": number
}`.trim();
Â 
Â Â Â Â Â  try {
Â Â Â Â Â Â Â  const raw = await callGeminiWithRetry(text, systemPrompt);
Â Â Â Â Â Â Â  const jsonText = extractJson(raw);
Â Â Â Â Â Â Â  const data = JSON.parse(jsonText);
Â 
Â Â Â Â Â Â Â  panel.classList.remove("hidden");
Â Â Â Â Â Â Â  content.innerHTML = `
Â Â Â Â Â Â Â Â Â  <div class="mb-4">
Â Â Â Â Â Â Â Â Â Â Â  <p class="font-bold text-blue-600">Note estimÃ©e : ${data.noteEstimation}/25</p>
Â Â Â Â Â Â Â Â Â Â Â  <p class="text-xs text-slate-500 italic mt-1">${data.analyseTextualite}</p>
Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â  <div class="space-y-3">
Â Â Â Â Â Â Â Â Â Â Â  <p class="font-bold text-red-500 text-xs uppercase">Erreurs dÃ©tectÃ©es :</p>
Â Â Â Â Â Â Â Â Â Â Â  ${(data.erreurs || []).map(err => `
Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="p-2 bg-red-50 border-l-2 border-red-300">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="line-through text-red-700">${err.texte}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <p class="text-xs text-slate-600 mt-1"><strong>${err.type} :</strong> ${err.conseil}</p>
Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  `).join("")}
Â Â Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â Â Â  <div class="space-y-2 mt-4">
Â Â Â Â Â Â Â Â Â Â Â  <p class="font-bold text-green-600 text-xs uppercase">Pistes d'amÃ©lioration :</p>
Â Â Â Â Â Â Â Â Â Â Â  <ul class="list-disc ml-4 text-xs space-y-1">
Â Â Â Â Â Â Â Â Â Â Â Â Â  ${(data.suggestions || []).map(s => `<li>${s}</li>`).join("")}
Â Â Â Â Â Â Â Â Â Â Â  </ul>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  `;
Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.error(error);
Â Â Â Â Â Â Â  showToast("Erreur lors de la communication avec l'IA (voir console).");
Â Â Â Â Â  } finally {
Â Â Â Â Â Â Â  btn.disabled = false;
Â Â Â Â Â Â Â  spinner.classList.add("hidden");
Â Â Â Â Â  }
Â Â Â  }
Â 
Â Â Â  async function callGeminiWithRetry(userText, systemPrompt, retries = 5, delay = 1000) {
Â Â Â Â Â  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`;
Â 
Â Â Â Â Â  const payload = {
Â Â Â Â Â Â Â  contents: [{ parts: [{ text: userText }] }],
Â Â Â Â Â Â Â  systemInstruction: { parts: [{ text: systemPrompt }] },
Â Â Â Â Â Â Â  generationConfig: {
Â Â Â Â Â Â Â Â Â  responseMimeType: "application/json"
Â Â Â Â Â Â Â  }
Â Â Â Â Â  };
Â 
Â Â Â Â Â  for (let i = 0; i < retries; i++) {
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â  const response = await fetch(url, {
Â Â Â Â Â Â Â Â Â Â Â  method: "POST",
Â Â Â Â Â Â Â Â Â Â Â  headers: { "Content-Type": "application/json" },
Â Â Â Â Â Â Â Â Â Â Â  body: JSON.stringify(payload)
Â Â Â Â Â Â Â Â Â  });
Â 
Â Â Â Â Â Â Â Â Â  if (!response.ok) {
Â Â Â Â Â Â Â Â Â Â Â  const t = await response.text();
Â Â Â Â Â Â Â Â Â Â Â  console.warn("Gemini error:", response.status, t);
Â Â Â Â Â Â Â Â Â Â Â  throw new Error(`HTTP ${response.status}: ${t}`);
Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â  const data = await response.json();
Â Â Â Â Â Â Â Â Â  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "";
Â Â Â Â Â Â Â Â Â  if (!text) throw new Error("RÃ©ponse vide (candidates/content/parts).");
Â Â Â Â Â Â Â Â Â  return text;
Â 
Â Â Â Â Â Â Â  } catch (err) {
Â Â Â Â Â Â Â Â Â  if (i === retries - 1) throw err;
Â Â Â Â Â Â Â Â Â  await new Promise(res => setTimeout(res, delay));
Â Â Â Â Â Â Â Â Â  delay *= 2;
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }
Â Â Â  }
Â 
Â Â Â  // init
Â Â Â  updateWordCount();
Â  </script>
</body>
</html>
