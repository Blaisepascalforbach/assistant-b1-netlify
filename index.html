<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assistant de Rédaction FLE B1</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <style>
    .step-active { border-bottom: 4px solid #3b82f6; color: #1e40af; }
    .word-count-success { color: #059669; font-weight: bold; }
    .word-count-warn { color: #d97706; }
    .word-count-error { color: #dc2626; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen font-sans">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="bg-white rounded-xl shadow-sm p-6 mb-6 border-l-8 border-blue-600">
      <h1 class="text-3xl font-bold text-slate-800">✍️ Assistant de Rédaction <span class="text-blue-600">B1</span></h1>
      <p class="text-slate-600 mt-2">Thème : <span class="italic">Forum de discussion - L'écologie au quotidien</span></p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg text-sm text-blue-800 border border-blue-100">
        <strong>Consigne d'examen :</strong> Vous participez à un forum de discussion intitulé
        "Consommer moins, vivre mieux ?". Vous donnez votre avis sur le zéro déchet.
        Est-ce possible selon vous ? Quels sont les avantages et les difficultés ? (160 mots minimum).
      </div>
    </header>

    <!-- Navigation Onglets -->
    <div class="flex space-x-4 mb-6 bg-white p-2 rounded-lg shadow-sm">
      <button onclick="switchTab('guidage')" id="tab-guidage"
        class="flex-1 py-2 text-center font-semibold step-active transition-all">
        <i class="fa-solid fa-map-signs mr-2"></i>Mode Guidage
      </button>

      <button onclick="switchTab('libre')" id="tab-libre"
        class="flex-1 py-2 text-center font-semibold text-slate-400 hover:text-slate-600 transition-all">
        <i class="fa-solid fa-pen-nib mr-2"></i>Rédaction Libre
      </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Zone d'écriture principale -->
      <div class="lg:col-span-2 space-y-4">

        <!-- Interface Guidage -->
        <div id="view-guidage" class="space-y-4">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-bold text-slate-700 mb-2">1. Introduction (Le contexte)</label>
            <select onchange="insertAmorce('intro', this)"
              class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="">Sélectionner une amorce...</option>
              <option value="Je voudrais réagir au message de...">Je voudrais réagir au message de...</option>
              <option value="Concernant le débat sur..., je pense que...">Concernant le débat sur..., je pense que...</option>
              <option value="C'est une question très actuelle car...">C'est une question très actuelle car...</option>
            </select>
            <textarea id="text-intro"
              class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[80px]"
              placeholder="Présentez le sujet..."></textarea>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-bold text-slate-700 mb-2">2. Corps du texte (Arguments)</label>
            <select onchange="insertAmorce('corps', this)"
              class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="">Sélectionner une amorce...</option>
              <option value="Tout d'abord, il faut dire que...">Tout d'abord, il faut dire que...</option>
              <option value="D'un côté..., mais d'un autre côté...">D'un côté..., mais d'un autre côté...</option>
              <option value="Par exemple, dans ma ville...">Par exemple, dans ma ville...</option>
            </select>
            <textarea id="text-corps"
              class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[150px]"
              placeholder="Développez vos idées..."></textarea>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-bold text-slate-700 mb-2">3. Conclusion (Synthèse)</label>
            <select onchange="insertAmorce('concl', this)"
              class="w-full mb-3 p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="">Sélectionner une amorce...</option>
              <option value="En conclusion, je crois que...">En conclusion, je crois que...</option>
              <option value="Pour finir, il est essentiel de...">Pour finir, il est essentiel de...</option>
              <option value="Et vous, qu'en pensez-vous ?">Et vous, qu'en pensez-vous ?</option>
            </select>
            <textarea id="text-concl"
              class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[80px]"
              placeholder="Terminez votre message..."></textarea>
          </div>
        </div>

        <!-- Interface Libre -->
        <div id="view-libre" class="hidden">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col">
            <label class="block text-sm font-bold text-slate-700 mb-2">Éditeur final</label>
            <textarea id="main-editor"
              class="flex-grow w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[350px]"
              placeholder="Votre texte complet ici..."></textarea>
          </div>
        </div>

        <!-- Actions Bas de Page -->
        <div class="flex flex-wrap gap-3 justify-between items-center bg-white p-4 rounded-xl shadow-sm">
          <div class="flex space-x-4 items-center">
            <button onclick="readText()" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Écouter le texte">
              <i class="fa-solid fa-volume-high text-xl"></i>
            </button>
            <div id="word-count-display" class="text-sm font-medium text-slate-500">
              Mots : <span id="word-count">0</span> / 160
            </div>
          </div>

          <button onclick="analyzeText()" id="btn-analyze"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center shadow-lg shadow-blue-200">
            <span id="analyze-spinner" class="hidden mr-2"><i class="fa-solid fa-circle-notch animate-spin"></i></span>
            <i class="fa-solid fa-bolt mr-2"></i>Analyser ma production
          </button>
        </div>
      </div>

      <!-- Barre latérale -->
      <aside class="space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">
            <i class="fa-solid fa-link mr-2 text-blue-500"></i>Connecteurs
          </h3>

          <div class="space-y-4">
            <div>
              <p class="text-xs font-bold text-slate-400 uppercase mb-2">Addition</p>
              <div class="flex flex-wrap gap-2">
                <button onclick="insertTool('De plus, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">De plus</button>
                <button onclick="insertTool('Par ailleurs, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">Par ailleurs</button>
                <button onclick="insertTool('Également, ')" class="text-xs bg-slate-100 hover:bg-blue-100 p-1.5 rounded transition border border-slate-200">Également</button>
              </div>
            </div>

            <div>
              <p class="text-xs font-bold text-slate-400 uppercase mb-2">Cause / Conséq.</p>
              <div class="flex flex-wrap gap-2">
                <button onclick="insertTool('Car ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">Car</button>
                <button onclick="insertTool('C\\'est pourquoi ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">C'est pourquoi</button>
                <button onclick="insertTool('Grâce à ')" class="text-xs bg-slate-100 hover:bg-green-100 p-1.5 rounded transition border border-slate-200">Grâce à</button>
              </div>
            </div>

            <div>
              <p class="text-xs font-bold text-slate-400 uppercase mb-2">Opposition</p>
              <div class="flex flex-wrap gap-2">
                <button onclick="insertTool('Pourtant, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">Pourtant</button>
                <button onclick="insertTool('Cependant, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">Cependant</button>
                <button onclick="insertTool('En revanche, ')" class="text-xs bg-slate-100 hover:bg-red-100 p-1.5 rounded transition border border-slate-200">En revanche</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Feedback Panel -->
        <div id="feedback-panel" class="hidden bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
          <h3 class="font-bold text-slate-800 mb-3 flex items-center">
            <i class="fa-solid fa-chart-line mr-2 text-blue-500"></i>Résultats
          </h3>
          <div id="feedback-content" class="text-sm space-y-4"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-xl hidden transition-opacity duration-300">
    Une erreur est survenue.
  </div>

  <!-- SCRIPT INTÉGRÉ (Netlify Function) -->
  <script>
    /* =========================
       CONFIGURATION (Netlify)
       ========================= */

    // ✅ On appelle la fonction Netlify (clé Gemini côté serveur)
    const ANALYZE_ENDPOINT = "/.netlify/functions/analyze";

    /* =========================
       ÉTAT DE L’APPLICATION
       ========================= */

    let currentTab = "guidage";
    let lastFocusedId = "text-intro";

    document.querySelectorAll("textarea").forEach(el => {
      el.addEventListener("focus", () => (lastFocusedId = el.id));
      el.addEventListener("input", updateWordCount);
    });

    /* =========================
       OUTILS UI
       ========================= */

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 5000);
    }

    function getFullText() {
      if (currentTab === "guidage") {
        return [
          document.getElementById("text-intro").value || "",
          document.getElementById("text-corps").value || "",
          document.getElementById("text-concl").value || ""
        ].join("\n\n").trim();
      }
      return (document.getElementById("main-editor").value || "").trim();
    }

    function updateWordCount() {
      const text = getFullText();
      const words = text ? text.trim().split(/\s+/).filter(Boolean).length : 0;

      const display = document.getElementById("word-count");
      display.textContent = words;
      display.className = "";

      if (words >= 160) display.classList.add("word-count-success");
      else if (words > 120) display.classList.add("word-count-warn");
      else display.classList.add("word-count-error");
    }

    function switchTab(tab) {
      currentTab = tab;

      const guidage = document.getElementById("view-guidage");
      const libre = document.getElementById("view-libre");
      const tabG = document.getElementById("tab-guidage");
      const tabL = document.getElementById("tab-libre");

      if (tab === "libre") {
        document.getElementById("main-editor").value = getFullText();
        guidage.classList.add("hidden");
        libre.classList.remove("hidden");

        tabL.classList.add("step-active");
        tabG.classList.remove("step-active");

        tabL.classList.remove("text-slate-400");
        tabG.classList.add("text-slate-400");

        lastFocusedId = "main-editor";
      } else {
        guidage.classList.remove("hidden");
        libre.classList.add("hidden");

        tabG.classList.add("step-active");
        tabL.classList.remove("step-active");

        tabG.classList.remove("text-slate-400");
        tabL.classList.add("text-slate-400");

        lastFocusedId = "text-intro";
      }

      updateWordCount();
    }

    function insertTool(text) {
      const el = document.getElementById(lastFocusedId);
      if (!el) return;

      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;

      el.value = el.value.substring(0, start) + text + el.value.substring(end);
      el.focus();
      el.selectionStart = el.selectionEnd = start + text.length;

      updateWordCount();
    }

    function insertAmorce(segment, select) {
      if (!select.value) return;
      const el = document.getElementById("text-" + segment);
      el.value = select.value + "\n" + (el.value || "");
      select.value = "";
      updateWordCount();
    }

    function readText() {
      const text = getFullText();
      if (!text) return;

      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "fr-FR";
      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    /* =========================
       ANALYSE (via Netlify)
       ========================= */

    function extractJson(text) {
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      if (start === -1 || end === -1 || end <= start) {
        throw new Error("Réponse non-JSON");
      }
      return text.slice(start, end + 1);
    }

    async function analyzeText() {
      const text = getFullText();
      if (text.trim().length < 20) {
        showToast("Texte trop court pour être analysé.");
        return;
      }

      const btn = document.getElementById("btn-analyze");
      const spinner = document.getElementById("analyze-spinner");
      const panel = document.getElementById("feedback-panel");
      const content = document.getElementById("feedback-content");

      btn.disabled = true;
      spinner.classList.remove("hidden");

      const systemPrompt = `
Tu es un examinateur expert en certifications DELF B1.
Analyse la production écrite de l'apprenant.
Réponds STRICTEMENT en JSON (aucun texte autour) avec cette structure :
{
  "analyseTextualite": "string (résumé global de la cohérence)",
  "erreurs": [{"texte":"string","type":"Grammaire/Lexique/Orthographe","conseil":"string"}],
  "suggestions": ["string"],
  "noteEstimation": number
}`.trim();

      try {
        const raw = await callGeminiWithRetry(text, systemPrompt);
        const jsonText = extractJson(raw);
        const data = JSON.parse(jsonText);

        panel.classList.remove("hidden");
        content.innerHTML = `
          <div class="mb-4">
            <p class="font-bold text-blue-600">Note estimée : ${data.noteEstimation}/25</p>
            <p class="text-xs text-slate-500 italic mt-1">${data.analyseTextualite}</p>
          </div>

          <div class="space-y-3">
            <p class="font-bold text-red-500 text-xs uppercase">Erreurs détectées :</p>
            ${(data.erreurs || []).map(err => `
              <div class="p-2 bg-red-50 border-l-2 border-red-300">
                <span class="line-through text-red-700">${err.texte}</span>
                <p class="text-xs text-slate-600 mt-1"><strong>${err.type} :</strong> ${err.conseil}</p>
              </div>
            `).join("")}
          </div>

          <div class="space-y-2 mt-4">
            <p class="font-bold text-green-600 text-xs uppercase">Pistes d'amélioration :</p>
            <ul class="list-disc ml-4 text-xs space-y-1">
              ${(data.suggestions || []).map(s => `<li>${s}</li>`).join("")}
            </ul>
          </div>
        `;
      } catch (error) {
        console.error(error);
        showToast("Erreur lors de la communication avec l'IA (voir console).");
      } finally {
        btn.disabled = false;
        spinner.classList.add("hidden");
      }
    }

    async function callGeminiWithRetry(userText, systemPrompt, retries = 3, delay = 700) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(ANALYZE_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userText, systemPrompt })
          });

          const data = await response.json().catch(async () => ({ error: await response.text() }));
          if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);

          const text = data?.text ?? "";
          if (!text) throw new Error("Réponse vide (champ text).");
          return text;

        } catch (err) {
          if (i === retries - 1) throw err;
          await new Promise(res => setTimeout(res, delay));
          delay *= 2;
        }
      }
    }

    // init
    updateWordCount();
  </script>
</body>
</html>
